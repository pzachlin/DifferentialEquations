%!TEX root = ../main.tex
\documentclass{ximera}

\input{../preamble.tex}



\title{Solving ODEs with Sage}


\begin{document}

\begin{abstract}
This activity shows how to use Sage to solve differential equations.

\end{abstract}

\maketitle

The templates in this section provide sample Sage code for vector operations. You can access our code through the link at the bottom of each template.  Feel free to modify the code and experiment to learn more! 
 
You can write your own code using Octave software or online Octave cells.  To access Octave cells online, go to the \href{https://sagecell.sagemath.org/}{Sage Math Cell Webpage}, select OCTAVE as the language, enter your code, and press EVALUATE. 
 
To ''save" or share your online code, click on the \emph{Share} button, select \emph{Permalink}, then copy the address directly from the browser window.  You can store this link to access your work later or share this link with others.  You will need to get a new Permalink every time you modify the code.

Let's first consider the problem of finding the general solution of an ODE symbolically. As an example, let's consider the differential equation:
\[
\frac{dx}{dt} = t - x
\]

The Sage function $\mathtt{desolve}$ is used to find symbolic solutions of ODEs. The following Sage cell shows how to solve the ODE above:

\begin{sageCell}
t = var('t')
x = function('x')(t)
de = diff(x, t) ==  t - x
soln = desolve(de, [x, t])
soln
\end{sageCell}

Clicking the \textbf{Evaluate} button will execute the cell and compute the general solution of the differential equation. 

\begin{problem} In the answer box below, enter the general solution of the differential equation 

Use the variable $C$ for the constant of integration.

The general solution of the DE is: $\answer{((t - 1)e^{t} + C)e^{-t}}$.
\end{problem}

\emph{Hint}: If you are getting an error, you are probably trying to enter $\_C$ as your constant of integration. Use the variable $C$ instead.

We can also use  $\mathtt{desolve}$  to find the solution of initial value problems. Let's, for example, consider the problem:
\[
\frac{dx}{dt} = t - x,\quad x(1) = 3
\]

The following Sage cell demonstrates how to solve this problem:

\begin{sageCell}
t = var('t')
x = function('x')(t)
de = diff(x, t) ==  t - x
soln = desolve(de, [x, t], ics=[1,3])
soln
\end{sageCell}

\begin{problem} 
The  solution of the initial value problem is: $\answer{((t - 1)e^{t} + 3e)e^{-t}}$.
\end{problem}

If we need a single numerical value of the solution, we can compute it as shown in the cell below:
\begin{sageCell}
soln(3.2).n()
\end{sageCell}

\begin{problem} Use the Sage cell above to compute the following values for the solution of the IVP:

$x(3.2)=\answer{2.53240947508700}$

$x(1.4)=\answer{2.41096013810692}$

$x(0.75)=\answer{3.60207625006322}$

\end{problem}

More often than not, we need several values of the solution of the ODE. The following Sage cell demonstrates how to 

\begin{sageCell}
[soln(tval).n() for tval in srange(1, 2, 0.1)]
\end{sageCell}

The output of the previous cell is a \emph{list}, with the values of the solution in a specified range. The range is defined by the Sage expression:
\[
\mathtt{srange(1, 2, 0.1)}
\]
This expression defines the following range of values in Sage: 
\[
\mathtt{[1,1.1,1.2,1.3,1.4,1.5,1.6,1.7,1.8,1.9]}
\]
Notice that the final value of the range is $1.9$, not $2.0$ as one might expect. This is a convention that Sage inherits from Python, where the rightmost element of a range expression is never actually included in the range. On way to think of it is that, in the expression $\mathtt{srange(a, b, s)}$, the set of values specified is a subset of the semi-open interval $[a,b)$.

Let's now plot the solution of the differential equation:

\begin{sageCell}
t = var('t')
x = function('x')(t)
de = diff(x, t) ==  t - x
soln = desolve(de, [x, t], ics=[1,3])
plot(soln(t), (t, 1, 5))
\end{sageCell}

\begin{problem} Answer the following question based on the plot generated by the Sage cell above:

The value of $x(4)$ is in the interval:
\wordChoice{\choice{$[1,1.5)$}, \choice{$[1.5,2)$}, \choice{$[2,2.5)$}, 
\choice{$[2.5,3)$}, \choice[correct]{$[3,3.5)$}, \choice{$[3.5,4)$}, \choice{$[4,4.5)$},
\choice{$[4.5,5)$}}

\end{problem}

In an applied problem, a symbolic solution will rarely be available, and one must resort to numerical solutions. As an example, let's consider the following model for a population with harvesting:
\[
\frac{dx}{dt}=rx\left(1-\frac{x}{t}\right)-h
\]
In this equation, the parameter $h$ represents a harvesting rate (in units of number of individuals per unit of time). Let's first try to solve this equation symbolically in Sage, for the parameter values $r=0.2$, $C=32$, $h=2.2$ and  the initial condition $x(0)=15$:

\begin{sageCell}
t = var('t')
x = function('x')(t)
r, C, h = 0.2, 32, 2.2
de = diff(x, t) == r * x *(1 - x/C) - h
soln = desolve(de, [x, t], ics=[0,15])
soln
\end{sageCell}

Evaluating the cell above, we can see that the symbolic solution looks quite complicated. Notice that the function that represents the solution, $x(t)$, has not been isolated in the left-hand side of the equation. In other words, this the solution is given in implicit form. In cases like this, it may be preferable to use a numerical method. This can be done in Sage as shown in the following cell, using the function $\mathtt{desolve\_odeint}$. Notice that the interface for this function differs in a significant way from the function $\mathtt{odeint}$

\begin{sageCell}
x = var('x')
r, C = 0.2, 32
h = 2.2
de = r * x *(1 - x/C) - h
tvalues = srange(0, 20, 0.2)
ic = 15
xvalues = desolve_odeint(de, ic, tvalues, x)
points(zip(tvalues, xvalues))
\end{sageCell}

\begin{problem} From the plot generated by the Sage cell above, we can conclude that the population $x(t)$:
\begin{multipleChoice}
\choice{Grows without bound as $t\to\infty$.}
\choice{Stabilizes near a certain positive value as $t\to\infty$.}
\choice[correct]{Becomes extinct at a certain finite value of $t$.}
\choice{Oscillates around some value as $t\to\infty$.}
\end{multipleChoice}
\end{problem}

\begin{problem} 
Change the value of $h$ in the cell above to 1.5 and run the cell again. Experiment with the maximum value of $t$ specified in the statement:
\[
\mathtt{tvalues = srange(0, 20, 0.2)}
\]
Notice that, as you increase the maximum value of $t$, you may also want to increase the value of the step-size. Answer the following question based on your experiments:

For the harvesting rate $h=2.2$ the population $x(t)$:
\begin{multipleChoice}
\choice{Grows without bound as $t\to\infty$.}
\choice[correct]{Stabilizes near a certain positive value as $t\to\infty$.}
\choice{Becomes extinct at a certain finite value of $t$.}
\choice{Oscillates around some value as $t\to\infty$.}
\end{multipleChoice}
\end{problem}

\begin{problem} It is of interest to determine what is the largest value of the harvesting rate $h$ we can choose so that we have a stable population in the model. Experiment with different values in the Sage cell above to determine this value approximately to three decimal places. 

Notice that you may also have to adjust the maximum value of the time variable $t$, since the differential equation becomes unstable for certain values of $h$, which leads to numerical errors in the computation.

The maximum value of the harvesting rate, to three decimal places is: $\answer{1.593}$
\end{problem}

\end{document}
